<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VCF 2V0-13.25 Quiz</title>
  <style>
    :root{
      --bg:#07101f; --card:#0f1f3f; --text:#eaf0ff; --muted:#9bb0d0; --line:rgba(255,255,255,.12);
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --btn:#142a55;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;background:linear-gradient(180deg,#050b16, #07101f 30%, #07101f);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(7,16,31,.9);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .toprow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border:1px solid var(--line);background:rgba(255,255,255,.04);border-radius:999px;color:var(--text);font-size:13px}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    button{
      background:var(--btn);color:var(--text);border:1px solid var(--line);
      padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer
    }
    button:disabled{opacity:.45;cursor:not-allowed}
    main{max-width:980px;margin:0 auto;padding:16px 14px 80px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
      border:1px solid var(--line);border-radius:18px;padding:18px
    }
    .qhead{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:12px}
    .qtitle{font-size:18px;font-weight:800;margin:0;line-height:1.55}
    .qmeta{color:var(--muted);font-size:13px}
    .opts{display:flex;flex-direction:column;gap:10px;margin:14px 0 10px}
    .opt{
      border:1px solid var(--line);background:rgba(255,255,255,.03);
      padding:12px 12px;border-radius:14px;display:flex;gap:10px;align-items:center
    }
    .opt input{width:20px;height:20px}
    .opt span{line-height:1.55}
    .feedback{
      margin-top:12px;border-radius:14px;padding:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);display:none
    }
    .feedback.ok{border-color:rgba(34,197,94,.55);background:rgba(34,197,94,.08)}
    .feedback.bad{border-color:rgba(239,68,68,.55);background:rgba(239,68,68,.08)}
    .feedback.warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.08)}
    .feedback .title{font-weight:900;margin-bottom:6px;display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    .footerbar{
      position:fixed;left:0;right:0;bottom:0;background:rgba(7,16,31,.92);
      backdrop-filter: blur(10px);border-top:1px solid var(--line)
    }
    .footerbar .wrap{display:flex;gap:10px;align-items:center;justify-content:space-between}
    a{color:#9bd2ff}
    .linkrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="toprow">
      <div class="pills">
        <div class="pill">نوع: <strong id="modePill">-</strong></div>
        <div class="pill">السؤال: <strong id="posPill">0/0</strong></div>
        <div class="pill">صح: <strong id="okPill">0</strong></div>
        <div class="pill">خطأ: <strong id="badPill">0</strong></div>
      </div>
      <div class="btnrow">
        <button id="shuffleBtn">Shuffle</button>
        <button id="resetBtn">Reset</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="qhead">
      <div>
        <div class="qmeta" id="qType">-</div>
        <h1 class="qtitle" id="qText">جاري التحميل…</h1>
      </div>
      <div class="qmeta" id="qIndex">Question -</div>
    </div>

    <div class="opts" id="options"></div>

    <div class="feedback" id="feedback">
      <div class="title" id="fbTitle">-</div>
      <div id="fbBody">-</div>
    </div>

    <div class="small">
      مصدر الأسئلة: <a href="./questions.json" target="_blank" rel="noopener">questions.json</a>
    </div>
  </div>
</main>

<div class="footerbar">
  <div class="wrap">
    <div class="linkrow">
      <button id="prevBtn">Prev</button>
      <button id="nextBtn">Next</button>
      <button id="finishBtn">Finish</button>
    </div>
    <div class="qmeta" id="hint">Next يمشي حتى لو خطأ + ترتيب الأسئلة/الخيارات عشوائي.</div>
  </div>
</div>

<script>
  const QUESTIONS_URL = "./questions.json";
  const SHUFFLE_QUESTIONS_ON_LOAD = true;
  const SHUFFLE_CHOICES_ON_RENDER = true;

  const modePill = document.getElementById("modePill");
  const posPill  = document.getElementById("posPill");
  const okPill   = document.getElementById("okPill");
  const badPill  = document.getElementById("badPill");

  const qTypeEl  = document.getElementById("qType");
  const qTextEl  = document.getElementById("qText");
  const qIndexEl = document.getElementById("qIndex");
  const optionsEl= document.getElementById("options");

  const feedbackEl = document.getElementById("feedback");
  const fbTitleEl  = document.getElementById("fbTitle");
  const fbBodyEl   = document.getElementById("fbBody");

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  const shuffleBtn = document.getElementById("shuffleBtn");
  const resetBtn = document.getElementById("resetBtn");

  let allQuestions = [];
  let order = [];
  let i = 0;
  let stats = { ok:0, bad:0 };
  let answered = [];

  // نخزن شفل الخيارات لكل سؤال (حسب id)
  // choiceState[qIndex] = { choices:[], mapNewToOld:[], mapOldToNew:[] }
  let choiceState = {};

  function shuffleArray(arr){
    for(let k=arr.length-1; k>0; k--){
      const r = Math.floor(Math.random()*(k+1));
      [arr[k], arr[r]] = [arr[r], arr[k]];
    }
    return arr;
  }

  function normalizeType(t){
    if(!t) return "single";
    const s = String(t).toLowerCase();
    if(s.includes("multiple")) return "multiple";
    if(s.includes("single")) return "single";
    if(s.includes("choose one")) return "single";
    if(s.includes("choose multiple")) return "multiple";
    return s.trim() || "single";
  }

  function toArrayAnswer(ans){
    if(ans === null || ans === undefined) return null; // يعني ما فيه Answer Key
    if(Array.isArray(ans)) return ans.map(Number);
    if(ans === 0 || ans) return [Number(ans)];
    return [];
  }

  function getCurrent(){
    const q = allQuestions[ order[i] ];
    const type = normalizeType(q.type);
    const answer = toArrayAnswer(q.answer);
    const explain = q.explain || "";
    const text = q.q || q.question || q.text || "";
    const originalChoices = Array.isArray(q.choices) ? q.choices : [];

    // جهّز شفل الخيارات لهذا السؤال (مرة وحدة لكل سؤال في الجلسة)
    const qKey = order[i];
    if(!choiceState[qKey]){
      const idxs = originalChoices.map((_,ix)=>ix);
      if(SHUFFLE_CHOICES_ON_RENDER) shuffleArray(idxs);

      const newChoices = idxs.map(ix => originalChoices[ix]);
      const mapNewToOld = idxs.slice();
      const mapOldToNew = [];
      mapNewToOld.forEach((oldIx, newIx)=>{ mapOldToNew[oldIx]=newIx; });

      choiceState[qKey] = { choices:newChoices, mapNewToOld, mapOldToNew, originalChoices };
    }

    const st = choiceState[qKey];
    return { q, type, choices: st.choices, answer, explain, text, mapNewToOld: st.mapNewToOld, mapOldToNew: st.mapOldToNew, originalChoices: st.originalChoices };
  }

  function setFeedback(kind, title, bodyHtml){
    feedbackEl.classList.remove("ok","bad","warn");
    feedbackEl.classList.add(kind);
    fbTitleEl.textContent = title;
    fbBodyEl.innerHTML = bodyHtml;
    feedbackEl.style.display = "block";
  }

  function hideFeedback(){ feedbackEl.style.display = "none"; }

  function getSelectedNewIndices(type){
    const inputs = [...optionsEl.querySelectorAll("input[name='opt']")];
    if(type === "single"){
      const idx = inputs.findIndex(x => x.checked);
      return idx >= 0 ? [idx] : [];
    }else{
      return inputs.map((x,idx)=> x.checked ? idx : -1).filter(x=>x>=0);
    }
  }

  function sameSet(a,b){
    if(a.length !== b.length) return false;
    const A=[...a].sort((x,y)=>x-y);
    const B=[...b].sort((x,y)=>x-y);
    return A.every((v,ix)=> v===B[ix]);
  }

  function correctTextFromOldIndices(originalChoices, answerOldIdxs){
    return answerOldIdxs.map(ix => originalChoices[ix]).filter(Boolean).join(" | ");
  }

  function render(){
    if(!allQuestions.length){
      qTextEl.textContent = "لا يوجد أسئلة. تأكد أن questions.json موجود وصحيح.";
      optionsEl.innerHTML = "";
      prevBtn.disabled = true; nextBtn.disabled = true; finishBtn.disabled = true;
      return;
    }

    const { type, choices, text } = getCurrent();

    modePill.textContent = type;
    posPill.textContent = `${i+1}/${order.length}`;
    okPill.textContent = stats.ok;
    badPill.textContent = stats.bad;

    qTypeEl.textContent = type;
    qIndexEl.textContent = `Question ${i+1}`;
    qTextEl.textContent = text || `Question ${i+1}`;

    optionsEl.innerHTML = "";
    const inputType = (type === "single") ? "radio" : "checkbox";

    choices.forEach((c, idx) => {
      const row = document.createElement("label");
      row.className = "opt";
      row.innerHTML = `
        <input type="${inputType}" name="opt" value="${idx}" />
        <span>${c}</span>
      `;
      optionsEl.appendChild(row);
    });

    hideFeedback();
    prevBtn.disabled = (i === 0);
    nextBtn.disabled = (i === order.length - 1);
  }

  nextBtn.addEventListener("click", () => {
    const { type, answer, explain, mapNewToOld, mapOldToNew, originalChoices } = getCurrent();
    const selectedNew = getSelectedNewIndices(type);

    if(selectedNew.length === 0){
      setFeedback("warn","تنبيه","اختر إجابة أولاً ثم اضغط Next.");
      return;
    }

    // حوّل اختيار المستخدم (new) إلى أرقام الأصل (old) عشان نقارن بالـ answer اللي نفترضه old
    const selectedOld = selectedNew.map(n => mapNewToOld[n]);

    // لو ما فيه Answer Key أصلاً
    if(answer === null){
      setFeedback("warn","✅ تم تسجيل إجابتك",
        `ما عندي Answer Key في questions.json عشان أحدد صح/خطأ.<br>${explain ? `<div style="margin-top:8px;color:var(--muted)">${explain}</div>` : ""}`
      );
      if(i < order.length - 1){ i++; setTimeout(render, 200); }
      return;
    }

    const ok = sameSet(selectedOld, answer);

    if(!answered[order[i]]){
      answered[order[i]] = true;
      if(ok) stats.ok++; else stats.bad++;
      okPill.textContent = stats.ok;
      badPill.textContent = stats.bad;
    }

    const correctAnsText = correctTextFromOldIndices(originalChoices, answer) || "(غير محدد)";
    const explainHtml = explain ? `<div style="margin-top:8px;color:var(--muted)">${explain}</div>` : "";

    if(ok){
      setFeedback("ok","✅ صحيح",`الصحيح: <strong>${correctAnsText}</strong>${explainHtml}`);
    }else{
      setFeedback("bad","❌ خطأ",`الصحيح: <strong>${correctAnsText}</strong>${explainHtml}`);
    }

    // يمشي حتى لو خطأ
    if(i < order.length - 1){
      i++;
      setTimeout(render, 250);
    }
  });

  prevBtn.addEventListener("click", () => { if(i>0){ i--; render(); } });

  finishBtn.addEventListener("click", () => {
    setFeedback("ok","النتيجة",
      `خلصت.<br>✅ صح: <strong>${stats.ok}</strong><br>❌ خطأ: <strong>${stats.bad}</strong>`
    );
  });

  shuffleBtn.addEventListener("click", () => {
    order = shuffleArray(order);
    i = 0;
    stats = { ok:0, bad:0 };
    answered = [];
    choiceState = {}; // عشان يعيد شفل الخيارات
    render();
  });

  resetBtn.addEventListener("click", () => {
    i = 0;
    stats = { ok:0, bad:0 };
    answered = [];
    render();
  });

  async function load(){
    try{
      const res = await fetch(QUESTIONS_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error("questions.json لازم يكون Array []");

      allQuestions = data;
      order = allQuestions.map((_,idx)=>idx);
      if(SHUFFLE_QUESTIONS_ON_LOAD) shuffleArray(order);

      i = 0;
      stats = { ok:0, bad:0 };
      answered = [];
      choiceState = {};
      render();
    }catch(e){
      qTextEl.textContent = "ما قدرت أقرأ questions.json. تأكد إنه موجود وصحيح.";
      optionsEl.innerHTML = "";
      setFeedback("bad","خطأ تحميل", String(e));
      prevBtn.disabled = true; nextBtn.disabled = true; finishBtn.disabled = true;
    }
  }

  load();
</script>
</body>
</html>